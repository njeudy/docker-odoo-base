image: gitlab/dind:latest
services:
  - docker:dind
variables:
  REGISTRY_HOST: registry.panda-chi.io:5002
  TEST_IMAGE: $REGISTRY_HOST/$CI_PROJECT_PATH:$CI_COMMIT_REF_NAME
  RELEASE_IMAGE: $REGISTRY_HOST/$CI_PROJECT_PATH:latest
before_script:
  - export DOCKER_API_VERSION=1.22
  - docker info
  - docker-compose --version
buildJob:
  script:
    - docker build --pull --build-arg VCS_REF=`git rev-parse --short HEAD`  -t $TEST_IMAGE .
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $REGISTRY_HOST
    - docker push $TEST_IMAGE
